<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Scratch-ritual</title>
	<script type="text/javascript" src="./js/phaser.js"></script>
    <script type="text/javascript" src="./item.js"></script>
    <script type="text/javascript" src="./character.js"></script>
    
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    // Load items defined in items.json
    game.load.text('itemsJSON', 'items.json');
    // Load basic player attributes from json
    game.load.text('playerAttributes', 'playerAttributes.json');
    
}

var ITEM = ITEM || {};
var CHARACTER = CHARACTER || {};
var timer;
// inventory & ritual stage
var inventory = [];
var picker;
var ritualChosenItems = [];
// keys
var leftKey;
var rightKey;
var upKey;
var spaceKey;

// Generic Functions
function roll (min, max) {
    return Math.random() * (max-min) + min;
}



    
function create() {
    // adds assets into game area layered on top of each other in creation order
    // we're going to be using physics to enable the Arcade Physics system
    
    // Set up player character
    playerAttributes = game.cache.getText('playerAttributes');
    var player = new CHARACTER(playerAttributes);
    
    // Set up inventory
    inventory = [ 'skull', 'snake', 'bat', 'potatoe'];
    picker = 0;
//    // fetch items from json in cache, parse and add back to cache
//    game.cache._text['itemsJSON'] = JSON.parse(game.cache.getText('itemsJSON'));
//    // assign to allItems
//    var allItems = game.cache.getText('itemsJSON');
//    
    // Our controls
    // Keys to record
    this.leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
    this.rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
    this.upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
    this.downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
    this.spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

    // Stop the following keys from propagating up to the browser
    game.input.keyboard.addKeyCapture([ Phaser.Keyboard.LEFT, Phaser.Keyboard.RIGHT, Phaser.Keyboard.UP, Phaser.Keyboard.SPACEBAR ]);
    
    timer = game.time.create(false);
    //  Set a TimerEvent to occur after 2 seconds
    timer.loop(1000, this.addEnemySpell, this);
    
    console.log('begin');
    
    
}

function update() {
    

    // make an item choose, left-right to cycle items, up to select
    // Use left and right keys to select items in inventory
    if (this.leftKey.justDown) {
        // when left key is pressed cycle left in inventory
        if (picker > 0) {
            picker = picker - 1;
        }
        else if (picker == 0) {
            // cycle to rightmost end of inventory
            picker = inventory.length-1;
        }
        console.log('Selected: ' + inventory[picker].toUpperCase() + ' from inventory: ' + inventory);
    }
    else if (this.rightKey.justDown) {
        // when left key is pressed cycle left in inventory
        if (picker < inventory.length-1) {
            picker = picker + 1;
        }
        else if (picker == (inventory.length-1)) {
            // when at rightmost end of inventory, cycle to leftmost end of inventory
            picker = 0;
        }
        console.log('Selected: ' + inventory[picker].toUpperCase() + ' from inventory: ' + inventory);
    } else if (this.downKey.justDown){
        // Select item from inventory
        // if less than 3 add it into selection
        // or swap with last item
        if (ritualChosenItems.length < 3 ) {
            ritualChosenItems.push(inventory[picker]);
            inventory.pop(picker);
        } else {
            ritualChosenItems[2] = inventory[picker];
        }
        console.log("Chosen items: " + ritualChosenItems);
    } else if (this.upKey.justDown){
        // cast ritual with ritualChosenItems
        if (ritualChosenItems.length == 3 ) {
            ritualCast(ritualChosenItems, player);
        } else {
            console.log("You must prepare more items before ritual casting")
        }
    }

}

</script>

</body>
</html>